{"id":"talk-19w","title":"Platform hardening: submissions + Discord + admin safety","description":"Epic file: .context/plans/platform-hardening.md\n\nGoal: reduce production risk/abuse surface for submissions + Discord integration via invite expiry defaults, admin auth, rate limiting, retention, and docs.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-09T15:22:06.565699Z","created_by":"cole","updated_at":"2026-02-09T15:27:13.190619Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:server","epic","ops"]}
{"id":"talk-19w.1","title":"Discord: default invite expiration (DISCORD_INVITE_MAX_AGE_SECONDS)","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: Invite expiration defaults (configurable)\n\nContext:\n- Default-expiring invites reduce risk if links are leaked and keep old submissions from being joinable forever.\n\nScope boundaries:\n- ✅ IN scope: backend/config.ts (env var parsing + validation + DiscordConfig.inviteMaxAge), backend/discord.ts (use inviteMaxAge for max_age), ensure logs do not leak invite codes\n- ❌ OUT of scope: README updates (handled by docs bead), any changes to submission success page / QR code\n\nDone means:\n- loadEnv() supports DISCORD_INVITE_MAX_AGE_SECONDS with default 604800 and validation (0 or 1..604800)\n- DiscordService.createInvite uses config.inviteMaxAge for Discord API max_age\n- No logs include invite code/URL (treat as secret)\n\nVerification:\n- deno check --allow-import backend/index.ts — expected: no type errors\n- Manual: set DISCORD_INVITE_MAX_AGE_SECONDS=3600 and call POST /api/discord/test; confirm invite shows ~1h expiry in Discord UI\n\nRed-Green-Refactor plan:\n- Red: observe current createInvite uses max_age=0 (never expires)\n- Green: wire inviteMaxAge through config + Discord API call\n- Refactor: centralize config parsing helpers if needed\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:24:50.503901Z","created_by":"cole","updated_at":"2026-02-09T15:47:40.371752Z","closed_at":"2026-02-09T15:47:40.371566Z","close_reason":"Implemented DISCORD_INVITE_MAX_AGE_SECONDS with default 604800s (7 days) and validation (0 or 1..604800).\n\n- backend/config.ts: parses+validates env var; adds DiscordConfig.inviteMaxAge\n- backend/discord.ts: createInvite now uses inviteMaxAge for Discord API max_age\n- Security: real invite codes/URLs are no longer logged (code redacted)\n\nVerification:\n- deno check --allow-import backend/config.ts backend/discord.ts — PASS\n\nManual smoke:\n- Set DISCORD_INVITE_MAX_AGE_SECONDS=3600 and call POST /api/discord/test; verify invite shows ~1h expiry in Discord UI.","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:server","discord","ops"],"dependencies":[{"issue_id":"talk-19w.1","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:24:50.503901Z","created_by":"cole","metadata":"{}","thread_id":""}]}
{"id":"talk-19w.2","title":"Security: protect admin/test endpoints with ADMIN_TOKEN","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: Protect admin/test endpoints with ADMIN_TOKEN\n\nContext:\n- GET /api/submissions returns full submission data (PII). POST /api/discord/test can be used to spam Discord. Both must be protected.\n\nScope boundaries:\n- ✅ IN scope: backend/auth.ts (requireAdmin middleware + timing-safe compare helper), backend/index.ts (apply middleware to GET /api/submissions and POST /api/discord/test), keep ENABLE_TEST_API gating\n- ❌ OUT of scope: README updates (handled by docs bead), new admin UI\n\nDone means:\n- New backend/auth.ts exports requireAdmin() Hono middleware\n- Middleware enforces Authorization: Bearer $ADMIN_TOKEN, returns 500 if missing token and 401 if unauthorized\n- Token compare is timing-safe (no ===); pads to equal length before comparing\n- Auth failure logs include timestamp + cf-connecting-ip (but never the token value)\n- backend/index.ts routes /api/submissions and /api/discord/test are protected\n\nVerification:\n- deno check --allow-import backend/index.ts — expected: no type errors\n- Manual: curl GET /api/submissions without auth -> 401/500; with correct header -> 200\n- Manual: POST /api/discord/test requires both ADMIN_TOKEN auth and ENABLE_TEST_API=true\n\nRed-Green-Refactor plan:\n- Red: confirm endpoints currently accessible without auth\n- Green: add middleware + apply to routes\n- Refactor: share admin auth helper with autothread debug console if appropriate\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:25:02.464208Z","created_by":"cole","updated_at":"2026-02-09T15:48:18.489383Z","closed_at":"2026-02-09T15:48:18.489305Z","close_reason":"Protected admin/test surfaces with ADMIN_TOKEN bearer auth.\n\n- backend/auth.ts: reusable Hono middleware (requireAdmin) with timing-safe token compare + failure logging (timestamp + cf-connecting-ip; never logs token)\n- backend/autothread-debug.http.ts: refactored to reuse shared requireAdmin middleware\n- backend/index.ts: GET /api/submissions and POST /api/discord/test now require ADMIN_TOKEN (auth runs before ENABLE_TEST_API gating for /api/discord/test)\n\nVerification:\n- deno check --allow-import backend/auth.ts backend/autothread-debug.http.ts — PASS\n- deno check --allow-import backend/index.ts — FAIL (known TS JSONValue/Row typing at /api/submissions; addressed in talk-19w.6)\n\nManual smoke:\n- curl GET /api/submissions without Authorization -> 401/500\n- curl with Authorization: Bearer $ADMIN_TOKEN -> 200\n- POST /api/discord/test requires both ADMIN_TOKEN and ENABLE_TEST_API=true","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:server","auth","ops"],"dependencies":[{"issue_id":"talk-19w.2","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:25:02.464208Z","created_by":"cole","metadata":"{}","thread_id":""}]}
{"id":"talk-19w.3","title":"Abuse: SQLite-backed rate limiting for POST /api/submissions","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: Submission rate limiting (abuse control)\n\nContext:\n- Prevent burst spam and accidental double-submits from overwhelming Discord + SQLite.\n\nScope boundaries:\n- ✅ IN scope: backend/rate-limit.ts (RateLimiter + middleware), backend/config.ts (RATE_LIMIT_* env vars + RuntimeConfig), backend/index.ts (conditional middleware on POST /api/submissions), SQLite schema rate_limit_store\n- ❌ OUT of scope: Captcha, per-user auth, docs updates (handled by docs bead)\n\nDone means:\n- New backend/rate-limit.ts exports RateLimiter + rateLimitMiddleware(limiter)\n- Rate limit key uses cf-connecting-ip only (fallback \"unknown\")\n- Sliding window stored as JSON array of epoch_ms; includes updated_at for retention\n- Concurrency-safe transaction (BEGIN IMMEDIATE) with retry/backoff and fail-open on persistent SQLITE_BUSY\n- On limit: returns 429 JSON { error: \"Rate limit exceeded\" } and Retry-After header (int seconds, rounded up)\n\nVerification:\n- deno check --allow-import backend/index.ts — expected: no type errors\n- Manual: loop curl POST /api/submissions from one IP until 429; confirm Retry-After decreases over time\n\nRed-Green-Refactor plan:\n- Red: reproduce many quick submissions (currently all succeed)\n- Green: implement minimal limiter + middleware + env config\n- Refactor: tighten transaction/retry logic + logs\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:25:17.835655Z","created_by":"cole","updated_at":"2026-02-09T16:00:26.350983Z","closed_at":"2026-02-09T16:00:26.350780Z","close_reason":"Added SQLite-backed rate limiting for POST /api/submissions (abuse control).\n\n- backend/rate-limit.ts: RateLimiter + rateLimitMiddleware (cf-connecting-ip only; sliding window; BEGIN IMMEDIATE + retry/backoff; fail-open; 429 {error:\"Rate limit exceeded\"} + Retry-After header)\n- backend/config.ts: new RATE_LIMIT_ENABLED (default true), RATE_LIMIT_WINDOW_SECONDS (default 900), RATE_LIMIT_MAX (default 10) with fail-fast validation when enabled\n- backend/index.ts: wires rateLimitMiddleware(rateLimiter) onto /api/submissions when enabled (no behavior change when disabled); extracted submissionHandler to avoid duplication\n- Security: stop logging Discord invite URLs in submission final-result log (now redacted)\n\nVerification:\n- deno check --allow-import backend/index.ts — PASS\n- deno check --allow-import backend/config.ts backend/rate-limit.ts — PASS\n\nManual smoke:\n- Set RATE_LIMIT_WINDOW_SECONDS=60 RATE_LIMIT_MAX=3, submit 4 times quickly from same IP -> 4th returns 429 + Retry-After\n- Set RATE_LIMIT_ENABLED=false -> no 429s","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:server","ops"],"dependencies":[{"issue_id":"talk-19w.3","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:25:17.835655Z","created_by":"cole","metadata":"{}","thread_id":""}]}
{"id":"talk-19w.4","title":"DB: add indexes for submissions + autothread cooldown queries","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: DB indexes + optional retention (indexes portion)\n\nContext:\n- Indexes keep admin listing and autothread cooldown checks fast as data grows.\n\nScope boundaries:\n- ✅ IN scope: backend/index.ts (CREATE INDEX IF NOT EXISTS on talk_submissions_3(created_at)), backend/autothread/store.ts (CREATE INDEX IF NOT EXISTS on processed table (channel_id, status, processed_at))\n- ❌ OUT of scope: retention cron (separate bead), schema renames / data migrations\n\nDone means:\n- initDatabase() creates submissions created_at index idempotently\n- AutothreadStore.initTables() creates composite index for processed table idempotently\n- Index names are stable and include namespace/table name to avoid collisions\n\nVerification:\n- deno check --allow-import backend/index.ts — expected: no type errors\n- Manual: run autothread debug health endpoint and ensure initTables still succeeds\n\nRed-Green-Refactor plan:\n- Red: explain current lack of indexes + potential slow queries\n- Green: add CREATE INDEX IF NOT EXISTS statements\n- Refactor: group DB init/index creation into helpers if it improves clarity\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:25:27.123300Z","created_by":"cole","updated_at":"2026-02-09T15:49:35.713591Z","closed_at":"2026-02-09T15:49:35.713393Z","close_reason":"Added DB indexes to keep common queries fast.\n\n- backend/autothread/store.ts: CREATE INDEX IF NOT EXISTS idx_autothread_processed_1*_cooldown ON (channel_id, status, processed_at) (matches cooldown query)\n- backend/index.ts: CREATE INDEX IF NOT EXISTS idx_talk_submissions_3_created_at ON talk_submissions_3(created_at) for ORDER BY created_at DESC\n\nVerification:\n- deno check --allow-import backend/autothread/store.ts — PASS\n- deno check --allow-import backend/index.ts — FAIL (known TS JSONValue/Row typing at /api/submissions; addressed in talk-19w.6)\n\nManual smoke:\n- Hit /api/autothread/health and ensure AutothreadStore.initTables() still succeeds.","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:server","db","ops"],"dependencies":[{"issue_id":"talk-19w.4","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:25:27.123300Z","created_by":"cole","metadata":"{}","thread_id":""}]}
{"id":"talk-19w.5","title":"Ops: add retention cron for autothread logs + rate_limit_store","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: DB indexes + optional retention (retention portion)\n\nContext:\n- Keep non-critical log tables from growing unbounded; reduce storage + query overhead.\n\nScope boundaries:\n- ✅ IN scope: new backend/retention.cron.ts (daily cleanup), backend/config.ts (AUTOTHREAD_LOG_RETENTION_DAYS, RATE_LIMIT_RETENTION_DAYS), delete guardrails (allow-list, batching, transactions)\n- ❌ OUT of scope: deleting talk submissions, changing talk_submissions_* schema\n\nDone means:\n- backend/retention.cron.ts exists and deletes only from allow-listed tables\n- Retention is configurable and can be disabled by setting days=0\n- Deletes are batched (LIMIT 100) inside transactions; busy_timeout set; lock failures skip table and continue\n- Logs show deleted counts per table and cutoff date\n\nVerification:\n- deno check --allow-import backend/retention.cron.ts — expected: no type errors\n- Manual: insert fake old rows into autothread_processed / rate_limit_store then run retention cron once and confirm only those rows removed\n\nRed-Green-Refactor plan:\n- Red: confirm no retention exists today\n- Green: implement safe allow-listed cleanup with batching\n- Refactor: extract helper for per-table delete loop\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:25:45.547844Z","created_by":"cole","updated_at":"2026-02-09T16:04:34.979554Z","closed_at":"2026-02-09T16:04:34.979368Z","close_reason":"Implemented retention cron for non-critical tables (autothread logs + rate limiting store).\n\n- backend/config.ts: adds AUTOTHREAD_LOG_RETENTION_DAYS and RATE_LIMIT_RETENTION_DAYS (defaults 30; 0 disables) with non-negative integer validation; exposes as config.retention\n- backend/retention.cron.ts: daily cron-friendly job that allow-lists tables (autothread_processed_1, autothread_processed_1_sandbox, rate_limit_store), sets busy_timeout=30000, deletes in 100-row batches inside BEGIN IMMEDIATE transactions, skips table on lock errors, logs deleted counts + cutoff dates\n\nVerification:\n- deno check --allow-import backend/config.ts backend/retention.cron.ts — PASS\n\nManual smoke:\n- Set both retention env vars to 0 and run cron -> should log disabled + do nothing\n- Insert fake old rows then run cron -> should delete only allow-listed tables","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:server","ops"],"dependencies":[{"issue_id":"talk-19w.5","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:25:45.547844Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.5","depends_on_id":"talk-19w.3","type":"blocks","created_at":"2026-02-09T15:26:27.423970Z","created_by":"cole","metadata":"{}","thread_id":""}]}
{"id":"talk-19w.6","title":"API: paginate GET /api/submissions + response schema + shared types","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: API response shaping + docs polish (API portion)\n\nContext:\n- Admin tooling needs predictable JSON and pagination for submissions.\n\nScope boundaries:\n- ✅ IN scope: backend/index.ts (GET /api/submissions pagination + response schema), shared/types.ts (TalkSubmission + SubmissionsResponse)\n- ❌ OUT of scope: auth middleware implementation (separate bead), README updates (docs bead)\n\nDone means:\n- GET /api/submissions supports ?limit=&offset= with validation (limit 1-1000, offset >=0)\n- Response is { data, total, limit, offset } and JSON-safe (rows mapped to plain objects)\n- Uses two-query pattern: COUNT(*) for total and SELECT * LIMIT/OFFSET for data\n- shared/types.ts exports TalkSubmission + SubmissionsResponse matching the API\n\nVerification:\n- deno check --allow-import backend/index.ts — expected: no type errors\n- Manual: curl GET /api/submissions?limit=2&offset=0 returns 2 items and includes total/limit/offset\n\nRed-Green-Refactor plan:\n- Red: confirm current endpoint returns raw rows array (no pagination)\n- Green: implement query params + response wrapper + types\n- Refactor: extract pagination parsing helper if it improves clarity\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:26:00.109762Z","created_by":"cole","updated_at":"2026-02-09T15:53:51.906100Z","closed_at":"2026-02-09T15:53:51.905920Z","close_reason":"Implemented paginated, JSON-safe admin listing for GET /api/submissions.\n\n- backend/index.ts: parses limit/offset (defaults: limit=50 offset=0) with validation (limit 1..1000, offset non-negative); uses COUNT(*) + SELECT * LIMIT/OFFSET; maps sqlite Row -> plain object; returns { data, total, limit, offset }\n- shared/types.ts: added SubmissionsResponse interface for the paginated response\n\nVerification:\n- deno check --allow-import backend/index.ts — PASS\n- deno check --allow-import shared/types.ts — PASS\n\nManual smoke:\n- curl -H \"Authorization: Bearer $ADMIN_TOKEN\" \"/api/submissions?limit=2&offset=0\" returns { data, total, limit, offset }\n- invalid params (limit=1001, offset=-1, limit=abc) return 400","source_repo":".","compaction_level":0,"original_size":0,"labels":["api","area:server"],"dependencies":[{"issue_id":"talk-19w.6","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:26:00.109762Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.6","depends_on_id":"talk-19w.2","type":"blocks","created_at":"2026-02-09T15:26:27.446038Z","created_by":"cole","metadata":"{}","thread_id":""}]}
{"id":"talk-19w.7","title":"Docs: update README for invite expiry, admin auth, rate limiting, retention, pagination","description":"Epic: talk-19w\nEpic file: .context/plans/platform-hardening.md\nGate: API response shaping + docs polish (docs portion)\n\nContext:\n- Public docs must match deployed behavior and clearly document new env vars + auth requirements.\n\nScope boundaries:\n- ✅ IN scope: README.md updates for env vars + endpoint auth + pagination + invite expiry defaults\n- ❌ OUT of scope: implementing any backend behavior (handled by other beads)\n\nDone means:\n- README documents new env vars: DISCORD_INVITE_MAX_AGE_SECONDS, ADMIN_TOKEN, RATE_LIMIT_ENABLED, RATE_LIMIT_WINDOW_SECONDS, RATE_LIMIT_MAX, AUTOTHREAD_LOG_RETENTION_DAYS, RATE_LIMIT_RETENTION_DAYS\n- README documents auth requirements: GET /api/submissions and POST /api/discord/test require Authorization: Bearer $ADMIN_TOKEN\n- README documents pagination response shape for GET /api/submissions (data/total/limit/offset)\n- README documents default Discord invite expiry behavior (7 days) and how to override\n\nVerification:\n- Manual: read README top-to-bottom and confirm it matches current backend behavior and env var names\n\nRed-Green-Refactor plan:\n- Red: identify README sections that are now stale\n- Green: update the minimal set of sections so docs match reality\n- Refactor: de-duplicate repeated env var info\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-09T15:26:10.539787Z","created_by":"cole","updated_at":"2026-02-09T16:07:44.810132Z","closed_at":"2026-02-09T16:07:44.809932Z","close_reason":"Updated README to match current platform-hardening behavior.\n\n- Documents new env vars: DISCORD_INVITE_MAX_AGE_SECONDS, ADMIN_TOKEN, RATE_LIMIT_ENABLED/WINDOW_SECONDS/MAX, AUTOTHREAD_LOG_RETENTION_DAYS, RATE_LIMIT_RETENTION_DAYS\n- Updates /api/discord/test curl example to include Authorization: Bearer $ADMIN_TOKEN and notes ENABLE_TEST_API=true requirement\n- Updates API endpoint docs for /api/submissions admin auth + pagination response shape\n- Notes invite code is redacted in logs and shows default invite expiry behavior\n\nVerification:\n- Manual: read README Environment Variables + API Endpoints sections and confirm they match backend behavior","source_repo":".","compaction_level":0,"original_size":0,"labels":["area:docs"],"dependencies":[{"issue_id":"talk-19w.7","depends_on_id":"talk-19w","type":"parent-child","created_at":"2026-02-09T15:26:10.539787Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.7","depends_on_id":"talk-19w.1","type":"blocks","created_at":"2026-02-09T15:26:27.468047Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.7","depends_on_id":"talk-19w.2","type":"blocks","created_at":"2026-02-09T15:26:27.488573Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.7","depends_on_id":"talk-19w.3","type":"blocks","created_at":"2026-02-09T15:26:27.509421Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.7","depends_on_id":"talk-19w.4","type":"blocks","created_at":"2026-02-09T15:26:27.528699Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.7","depends_on_id":"talk-19w.5","type":"blocks","created_at":"2026-02-09T15:26:27.548617Z","created_by":"cole","metadata":"{}","thread_id":""},{"issue_id":"talk-19w.7","depends_on_id":"talk-19w.6","type":"blocks","created_at":"2026-02-09T15:26:27.568043Z","created_by":"cole","metadata":"{}","thread_id":""}]}
